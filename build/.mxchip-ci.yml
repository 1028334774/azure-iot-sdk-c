name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

jobs:
- job: Cross_Compile
  pool:
    vmImage: ubuntu-16.04
  steps:
  - script: |
      . build_all/mbed5/setup.sh
    displayName: 'setup'

  - script: |
      # . build_all/mbed5/build.sh
      sudo rm -R -f mxchip
      git clone -b rajeev/latest_mbed https://github.com/massand/mxchip_az3166_firmware.git mxchip
      # rsync -avz --existing ./ mxchip/mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/

      sudo npm install -g iotz
      sudo iotz update

      cd mxchip
      sudo git checkout -- mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/provisioning_client/adapters/hsm_client_riot.c
      sudo git checkout -- mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/provisioning_client/deps/RIoT/Reference/DICE/DiceSha256.c
      sudo git checkout -- mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/provisioning_client/deps/RIoT/Reference/RIoT/Core/RIoTCrypt/RiotDerEnc.c
      sudo git checkout -- mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/provisioning_client/deps/RIoT/Reference/RIoT/Core/RIoTCrypt/RiotEcc.c
      sudo git checkout -- mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/provisioning_client/deps/RIoT/Reference/RIoT/Core/RIoTCrypt/RiotSha256.c
      sudo iotz init mbed
      sudo iotz compile

      cd ..
    displayName: 'build'

  - script: |
      # Check that this is the right source directory
      ls
      cp mxchip/BUILD/AZ3166/GCC_ARM/mxchip.bin $(Build.ArtifactStagingDirectory)
    displayName: "Copy Files into Artifact repo"

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts: drop'
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'drop'
      publishLocation: 'Container'
    condition: succeeded()

- job: Execute
  dependsOn: Cross_Compile
  pool:
    name: $(AGENTPOOL)
  steps:
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts'
    inputs:
      artifactName: 'drop'

  - script: |
      cp $(System.ArtifactsDirectory)/drop/mxchip.bin /media/newt/AZ3166
    displayName: 'deploy'
